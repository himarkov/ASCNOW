<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_604347_ascnow.CommunicationUtils</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Utils for communication from the app to Azure</description>
        <name>CommunicationUtils</name>
        <script><![CDATA[var CommunicationUtils = Class.create();
CommunicationUtils.prototype = {
    initialize: function() {
    },
	
	//---------------------------------------------------------------
	
	// Log messages in system log
    log: function(msg) {
        gs.info(msg);
    },
	
	//---------------------------------------------------------------
	
	// Builds the ServiceNow REST message
    buildRESTMessage: function(method, uri, body, skipToken) {

        var token = this.getAccessToken(environment);

        request = new sn_ws.RESTMessageV2();

        // Default method is GET
        if(!method) {
            method = 'get';
        }
        request.setHttpMethod(method);

        if(skipToken) { 
            request.setQueryParameter('$skipToken', skipToken);
        }
		
        if(body) {
            request.setRequestBody(JSON.stringify(body));
        }
        
        request.setEndpoint(uri);
        request.setRequestHeader('Content-Type','application/json');
        request.setRequestHeader("Accept","application/json");
        request.setRequestHeader('Authorization','Bearer ' + token.getAccessToken());
        
        return request;

    },

    //---------------------------------------------------------------
    // Return skiptoken when more results to fetch during the API call
    getSkipToken: function(nextLink) {
        var skipToken = nextLink.split('&');
        skipToken = skipToken[skipToken.length -1].replace('$skipToken=', ''); //contains skitToken only

        return skipToken;
    },

    //---------------------------------------------------------------
    // Request access token using the saved application OAuth application
    getAccessToken: function(environment) {
        var oAuthClient = new sn_auth.GlideOAuthClient();
        var params = {grant_type:"client_credentials",resource:"https://management.azure.com/"};
        var tokenResponse = oAuthClient.requestToken(environment.oauth_provider,global.JSON.stringify(params)); //using the Oauth provider specified in the config table
        
        return tokenResponse.getToken();
    },

    //---------------------------------------------------------------

    type: 'CommunicationUtils'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2021-04-08 12:19:03</sys_created_on>
        <sys_id>b9f2e6cf071320100382f2218c1ed048</sys_id>
        <sys_mod_count>2</sys_mod_count>
        <sys_name>CommunicationUtils</sys_name>
        <sys_package display_value="ASCNOW" source="x_604347_ascnow">4a8412c7071320100382f2218c1ed0c4</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="ASCNOW">4a8412c7071320100382f2218c1ed0c4</sys_scope>
        <sys_update_name>sys_script_include_b9f2e6cf071320100382f2218c1ed048</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2021-04-08 12:32:28</sys_updated_on>
    </sys_script_include>
</record_update>
